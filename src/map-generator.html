<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Office Map</title>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      #map-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      #travel-info {
        padding: 10px;
        font-size: 14px;
        background-color: #f0f0f0;
      }

      #map {
        flex-grow: 1;
        /* Allow map to grow and fill remaining space */
        width: 100%;
      }

      .office-btn {
        margin: 5px;
        padding: 10px;
        background-color: lightblue;
        border: none;
        cursor: pointer;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.5/dist/xlsx.full.min.js"></script>
  </head>

  <body>
    <h1>Upload Excel File to Plot Employee and Office Locations</h1>
    <div id="map-container" style="display: none">
      <input type="file" id="fileInput" accept=".xlsx" />
      <div id="officeButtons"></div>
      <div id="travel-info"></div>
      <!-- Travel time and route info -->
      <div id="map"></div>
    </div>

    <script>
      let map;
      let officeButtons = {};
      let directionsService;
      let directionsRenderer;
      let trafficLayer;

      function getApiKey() {
        return new Promise((resolve, reject) => {
          let apiKey = window.localStorage.getItem("GoogleMapsAPIKey");
          if (!apiKey) {
            apiKey = window.prompt(
              "Please enter your Google Maps API Key:",
              ""
            );
            if (!apiKey) {
              window.alert("API Key is required. Please try again.");
              reject("INVALID_API_KEY");
            } else {
              window.localStorage.setItem("GoogleMapsAPIKey", apiKey);
              resolve(apiKey);
            }
          } else {
            resolve(apiKey);
          }
        });
      }

      function showUI() {
        getApiKey()
          .then((apiKey) => {
            const body = document.body;
            document.getElementById("map-container").style.display = "flex"; // Show the map view

            initMap(apiKey);
          })
          .catch((error) => {
            console.error("Failed to load the UI:", error);
          });
      }

      function initMap(apiKey) {
        if (!apiKey) {
          window.alert("API Key is required. Please try again.");
          return;
        }

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initCallback&libraries=geometry`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }

      function initCallback() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 20.5937, lng: 78.9629 }, // Default center (India)
          zoom: 5,
          mapTypeId: "terrain",
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        trafficLayer = new google.maps.TrafficLayer();
        trafficLayer.setMap(map);
      }

      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileUpload);

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            processWorkbook(workbook);
          };
          reader.readAsArrayBuffer(file);
        }
      }

      function processWorkbook(workbook) {
        workbook.SheetNames.forEach((sheetName) => {
          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet);
          plotLocations(jsonData);
        });
      }

      function plotLocations(data) {
        const officeLocations = {};

        // Loop through employee data and group employees by office
        data.forEach((row) => {
          const employeeId = row.employee_id;
          const employeeLat = parseFloat(row.home_latitude);
          const employeeLon = parseFloat(row.home_longitude);
          const officeLat = parseFloat(row.office_latitude);
          const officeLon = parseFloat(row.office_longitude);

          // Group employees by office
          const officeKey = `${officeLat},${officeLon}`;
          if (!officeLocations[officeKey]) {
            officeLocations[officeKey] = {
              lat: officeLat,
              lon: officeLon,
              employees: [],
            };
          }
          officeLocations[officeKey].employees.push({
            id: employeeId,
            lat: employeeLat,
            lon: employeeLon,
          });
        });

        // Plot employee home locations and create office buttons
        Object.keys(officeLocations).forEach((officeKey, index) => {
          const office = officeLocations[officeKey];
          const officeLat = office.lat;
          const officeLon = office.lon;
          const maxMiles = 40; // Specify the maximum distance in miles
          const { maxDistance, nearbyEmployees, faroffEmployees } =
            calculateMaxDistance(office, office.employees, maxMiles);

          // Create a button for each office
          const officeButton = document.createElement("button");
          officeButton.className = "office-btn";
          officeButton.textContent = `Office ${index + 1}`;
          officeButton.onclick = () =>
            focusOnOffice(officeLat, officeLon, maxDistance);
          document.getElementById("officeButtons").appendChild(officeButton);

          // Store the button reference for future use
          officeButtons[officeKey] = officeButton;

          if (nearbyEmployees.length > 0) {
            // Plot office circle dynamically based on the farthest employee
            new google.maps.Circle({
              strokeColor: "#0000FF",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#0000FF",
              fillOpacity: 0.45,
              map: map,
              center: { lat: officeLat, lng: officeLon },
              radius: maxDistance, // Dynamic radius to include all employees
            });
          }

          // Plot employee home locations
          nearbyEmployees.forEach((employee) => {
            const employeeMarker = new google.maps.Marker({
              position: { lat: employee.lat, lng: employee.lon },
              map: map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 4,
                fillColor: "green",
                fillOpacity: 1,
                strokeWeight: 1,
                strokeColor: "white",
              },
            });

            // Add click event to each employee marker
            employeeMarker.addListener("click", () => {
              showRouteAndTime(
                employee.lat,
                employee.lon,
                officeLat,
                officeLon
              );
            });
          });

          faroffEmployees.forEach((employee) => {
            const employeeMarker = new google.maps.Marker({
              position: { lat: employee.lat, lng: employee.lon },
              map: map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 4,
                fillColor: "red",
                fillOpacity: 1,
                strokeWeight: 1,
                strokeColor: "white",
              },
            });
          });

          // Plot the office location with a small office icon
          new google.maps.Marker({
            position: { lat: officeLat, lng: officeLon },
            map: map,
            icon: {
              url: "https://maps.google.com/mapfiles/kml/shapes/schools_maps.png", // Office icon
              scaledSize: new google.maps.Size(30, 30), // Scale the office icon
            },
          });
        });
      }

      function calculateMaxDistance(office, employees, maxMiles) {
        const officeLatLng = new google.maps.LatLng(office.lat, office.lon);
        const maxDistanceMeters = maxMiles * 1609.34; // Convert miles to meters

        // Filter employees within the max distance
        const nearbyEmployees = employees.filter((employee) => {
          const employeeLatLng = new google.maps.LatLng(
            employee.lat,
            employee.lon
          );
          const distance =
            google.maps.geometry.spherical.computeDistanceBetween(
              officeLatLng,
              employeeLatLng
            );
          return distance <= maxDistanceMeters;
        });

        const faroffEmployees = employees.filter((employee) => {
          return !nearbyEmployees.some((e) => e.id === employee.id);
        });

        // Calculate the maximum distance within the filtered employees
        let maxDistance = 0;
        nearbyEmployees.forEach((employee) => {
          const employeeLatLng = new google.maps.LatLng(
            employee.lat,
            employee.lon
          );
          const distance =
            google.maps.geometry.spherical.computeDistanceBetween(
              officeLatLng,
              employeeLatLng
            );
          if (distance > maxDistance) {
            maxDistance = distance;
          }
        });

        return {
          maxDistance,
          nearbyEmployees,
          faroffEmployees,
        }; // Returns the max distance in meters
      }

      function showRouteAndTime(startLat, startLng, endLat, endLng) {
        const start = new google.maps.LatLng(startLat, startLng);
        const end = new google.maps.LatLng(endLat, endLng);

        directionsService.route(
          {
            origin: start,
            destination: end,
            travelMode: "DRIVING",
          },
          (response, status) => {
            if (status === "OK") {
              directionsRenderer.setDirections(response);

              // Extract and show the travel time from the response
              const travelInfo = response.routes[0].legs[0];
              document.getElementById(
                "travel-info"
              ).textContent = `Travel time: ${travelInfo.duration.text}, Distance: ${travelInfo.distance.text}`;
            } else {
              console.error("Directions request failed due to " + status);
            }
          }
        );
      }

      function focusOnOffice(lat, lon, radius) {
        const officeLatLng = new google.maps.LatLng(lat, lon);

        // Create bounds based on the radius
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(
          google.maps.geometry.spherical.computeOffset(officeLatLng, radius, 0)
        ); // North
        bounds.extend(
          google.maps.geometry.spherical.computeOffset(officeLatLng, radius, 90)
        ); // East
        bounds.extend(
          google.maps.geometry.spherical.computeOffset(
            officeLatLng,
            radius,
            180
          )
        ); // South
        bounds.extend(
          google.maps.geometry.spherical.computeOffset(
            officeLatLng,
            radius,
            270
          )
        ); // West

        // Adjust the map to fit the bounds
        map.fitBounds(bounds);
      }

      document.addEventListener("DOMContentLoaded", showUI);
    </script>
  </body>
</html>
