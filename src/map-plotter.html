<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Office Map</title>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        #map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
        }

        #controls {
            padding: 10px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #officeButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        #travel-info {
            padding: 10px;
            font-size: 14px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }

        .office-btn {
            padding: 10px 15px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .office-btn:hover {
            background-color: #357ab8;
        }
    </style>

    <!-- XLSX Library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <header style="padding: 20px; background-color: #4a90e2; color: white;">
        <h1>Upload Excel File to Plot Employee and Office Locations</h1>
    </header>
    <div id="map-container" style="display: none;">
        <div id="controls">
            <input type="file" id="fileInput" accept=".xlsx" />
            <div id="officeButtons"></div>
        </div>
        <div id="map"></div>
        <div id="travel-info">Select an employee marker to view travel time and distance.</div>
    </div>

    <script>
        // Global Variables
        let googleMap;
        let directionsService;
        let directionsRenderer;
        let trafficLayer;

        // Cache DOM Elements
        const mapContainer = document.getElementById('map-container');
        const fileInput = document.getElementById('fileInput');
        const officeButtonsContainer = document.getElementById('officeButtons');
        const travelInfo = document.getElementById('travel-info');

        /**
         * Retrieves the Google Maps API Key from localStorage or prompts the user.
         * @returns {Promise<string>} The API Key.
         */
        async function getApiKey() {
            let apiKey = localStorage.getItem("GoogleMapsAPIKey");
            if (!apiKey) {
                apiKey = prompt("Please enter your Google Maps API Key:");
                if (!apiKey) {
                    alert("API Key is required. Please try again.");
                    throw new Error("INVALID_API_KEY");
                }
                localStorage.setItem("GoogleMapsAPIKey", apiKey);
            }
            return apiKey;
        }

        /**
         * Initializes the UI by fetching the API Key and loading the map.
         */
        async function showUI() {
            try {
                const apiKey = await getApiKey();
                mapContainer.style.display = "flex";
                await loadGoogleMapsScript(apiKey);
            } catch (error) {
                console.error("Failed to load the UI:", error);
            }
        }

        /**
         * Dynamically loads the Google Maps script.
         * @param {string} apiKey - The Google Maps API Key.
         * @returns {Promise<void>}
         */
        function loadGoogleMapsScript(apiKey) {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry`;
                script.async = true;
                script.defer = true;
                script.onerror = () => reject(new Error("Failed to load Google Maps script."));
                window.initMap = () => {
                    initializeMap();
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        /**
         * Initializes the Google Map and related services.
         */
        function initializeMap() {
            googleMap = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 20.5937, lng: 78.9629 }, // Default center (India)
                zoom: 5,
                mapTypeId: "terrain",
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(googleMap);

            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(googleMap);
        }

        /**
         * Handles the file upload event.
         * @param {Event} event - The file input change event.
         */
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await readExcelFile(file);
                const processedData = await processWorkbook(data);
                plotLocations(processedData);
            } catch (error) {
                console.error("Error processing file:", error);
                alert("Failed to process the uploaded file. Please check the console for details.");
            }
        }

        /**
         * Reads the Excel file and returns the workbook data.
         * @param {File} file - The uploaded Excel file.
         * @returns {Promise<Array<Object>>} The merged data from all sheets.
         */
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const mergedData = [];
                        workbook.SheetNames.forEach((sheetName) => {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet);
                            mergedData.push(...jsonData);
                        });
                        resolve(mergedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error("Failed to read the file."));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * Processes the workbook data to extract employee and office information.
         * @param {Array<Object>} data - The merged data from all sheets.
         * @returns {Promise<{ employeeList: Array<Object>, officeList: Array<Object> }>} The processed data.
         */
        async function processWorkbook(data) {
            const employeeList = [];
            const officeMap = new Map();

            const officeIds = [
                'Birmingham Office Postcode',
                'Caithness Office Postcode',
                'Cardiff Office Postcode',
                'Cheadle Office Postcode',
                'Crawley Office Postcode',
                'Exeter Office Postcode',
                'Lancing Office Postcode',
                'Leeds Office Postcode',
                'Liverpool Office Postcode',
                'London Office Postcode',
                'Reading Office Postcode',
                'Worthing Office Postcode',
                'Milwaukee Office Postcode',
                'Minnesota Office Postcode',
                'New York Office Postcode',
                'RPK Office Postcode',
                'Conshohocken Office Postcode',
            ];

            for (const row of data) {
                try {
                    const homeLocation = await getLocationFromZipCode(row['Home Postcode']);
                    if (!homeLocation) {
                        console.warn(`Invalid Home Postcode for Employee ID: ${row['Employee ID']}`);
                        continue;
                    }

                    const employee = {
                        id: row['Employee ID'],
                        zip_code: row['Home Postcode'],
                        latitude: homeLocation.latitude,
                        longitude: homeLocation.longitude,
                    };
                    employeeList.push(employee);

                    // Process each office postcode for the current employee
                    for (const officeId of officeIds) {
                        const officeZip = row[officeId];
                        if (officeZip) {
                            let office = officeMap.get(officeId);
                            if (!office) {
                                const officeLocation = await getLocationFromZipCode(officeZip);
                                if (!officeLocation) {
                                    console.warn(`Invalid Zip Code for ${officeId}: ${officeZip}`);
                                    continue;
                                }
                                office = {
                                    id: officeId,
                                    zip_code: officeZip,
                                    latitude: officeLocation.latitude,
                                    longitude: officeLocation.longitude,
                                    employees: [],
                                };
                                officeMap.set(officeId, office);
                            }
                            office.employees.push(employee);
                        }
                    }
                } catch (error) {
                    console.error(`Error processing row for Employee ID: ${row['Employee ID']}`, error);
                }
            }

            const officeList = Array.from(officeMap.values());
            return { employeeList, officeList };
        }

        /**
         * Retrieves the geographical location for a given zip code.
         * @param {string} zipCode - The postal code.
         * @returns {Promise<{ latitude: number, longitude: number } | null>} The location or null if not found.
         */
        function getLocationFromZipCode(zipCode) {
            return new Promise((resolve, reject) => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: zipCode.toString() }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            latitude: location.lat(),
                            longitude: location.lng(),
                        });
                    } else {
                        console.warn(`Geocode failed for zip code ${zipCode}: ${status}`);
                        resolve(null);
                    }
                });
            });
        }

        /**
         * Plots employee and office locations on the map and creates office buttons.
         * @param {{ employeeList: Array<Object>, officeList: Array<Object> }} data - The processed data.
         */
        function plotLocations(data) {
            // Clear previous markers and buttons if any
            officeButtonsContainer.innerHTML = '';
            // Optionally, you can keep track of markers to clear them later

            data.officeList.forEach((office) => {
                const officeLatLng = { lat: office.latitude, lng: office.longitude };

                // Create a button for the office
                const officeButton = document.createElement("button");
                officeButton.className = "office-btn";
                officeButton.textContent = office.id.replace(' Office Postcode', '');
                officeButton.addEventListener("click", () => focusOnOffice(officeLatLng));
                officeButtonsContainer.appendChild(officeButton);

                // Draw a circle around the office to represent the area (optional)
                new google.maps.Circle({
                    strokeColor: "#0000FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#0000FF",
                    fillOpacity: 0.1,
                    map: googleMap,
                    center: officeLatLng,
                    radius: 160934, // 100 miles in meters
                });

                // Add an office marker
                new google.maps.Marker({
                    position: officeLatLng,
                    map: googleMap,
                    icon: {
                        url: "https://maps.google.com/mapfiles/kml/shapes/office_maps.png", // Custom Office Icon
                        scaledSize: new google.maps.Size(30, 30),
                    },
                    title: office.id.replace(' Office Postcode', ''),
                });

                // Plot employee markers
                office.employees.forEach((employee) => {
                    const employeeLatLng = { lat: employee.latitude, lng: employee.longitude };
                    const markerColor = getDistanceColor(employee, office);

                    const employeeMarker = new google.maps.Marker({
                        position: employeeLatLng,
                        map: googleMap,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 6,
                            fillColor: markerColor,
                            fillOpacity: 1,
                            strokeWeight: 1,
                            strokeColor: "white",
                        },
                        title: `Employee ID: ${employee.id}`,
                    });

                    // Add click event to show route and travel time
                    employeeMarker.addListener("click", () => {
                        showRouteAndTime(employeeLatLng, officeLatLng);
                    });
                });
            });
        }

        /**
         * Determines the color of the employee marker based on distance or other criteria.
         * @param {Object} employee - The employee object.
         * @param {Object} office - The office object.
         * @returns {string} The color code.
         */
        function getDistanceColor(employee, office) {
            // Placeholder for distance-based coloring logic
            // For example, green for nearby, red for far
            // You can implement actual distance calculations here
            return "green";
        }

        /**
         * Displays the route and travel time between two locations on the map.
         * @param {{ lat: number, lng: number }} origin - The starting point.
         * @param {{ lat: number, lng: number }} destination - The ending point.
         */
        async function showRouteAndTime(origin, destination) {
            try {
                const response = await directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: "DRIVING", // Changed to a valid travel mode
                });

                directionsRenderer.setDirections(response);

                const leg = response.routes[0].legs[0];
                travelInfo.textContent = `Travel time: ${leg.duration.text}, Distance: ${leg.distance.text}`;
            } catch (error) {
                console.error("Directions request failed:", error);
                alert("Failed to retrieve directions. Please try again.");
            }
        }

        /**
         * Focuses the map on a specific office location.
         * @param {{ lat: number, lng: number }} officeLatLng - The office location.
         */
        function focusOnOffice(officeLatLng) {
            googleMap.setCenter(officeLatLng);
            googleMap.setZoom(10); // Adjust zoom level as needed
        }

        // Event Listeners
        document.addEventListener("DOMContentLoaded", showUI);
        fileInput.addEventListener("change", handleFileUpload);
    </script>
</body>

</html>
