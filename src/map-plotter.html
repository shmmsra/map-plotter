<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Office Map</title>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        #map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
        }

        #controls {
            padding: 10px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-btn {
            padding: 10px;
            background-color: lightcoral;
            border: none;
            cursor: pointer;
        }

        .export-btn {
            background-color: lightgreen;
        }


        #officeButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        #travel-info {
            padding: 10px;
            font-size: 14px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }

        .office-btn {
            padding: 10px 15px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .office-btn:hover {
            background-color: #357ab8;
        }
    </style>

    <!-- XLSX Library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <header style="padding: 4px 16px 4px 16px; background-color: #4a90e2; color: white;">
        <h2>Upload Excel File to Plot Employee and Office Locations</h2>
    </header>
    <div id="map-container" style="display: none;">
        <div id="controls">
            <button id="resetApiKey" class="control-btn">Reset API Key</button>
            <button id="exportData" class="control-btn export-btn">Export Data</button>
            <input type="file" id="fileInput" accept=".xlsx" />
            <div id="officeButtons"></div>
        </div>
        <div id="map"></div>
        <div id="travel-info">Select an employee marker to view travel time and distance.</div>
    </div>

    <script>
        // Global Variables
        let googleMap;
        let directionsService;
        let directionsRenderer;
        let trafficLayer;
        let processedData;

        // Cache DOM Elements
        const mapContainer = document.getElementById('map-container');
        const fileInput = document.getElementById('fileInput');
        const officeButtonsContainer = document.getElementById('officeButtons');
        const travelInfo = document.getElementById('travel-info');

        // Event listener for reset button
        document.getElementById('resetApiKey').addEventListener('click', () => {
            localStorage.removeItem("GoogleMapsAPIKey");
            window.location.reload();
        });

        // Function to export JSON data to Excel
        function exportJsonToExcel(jsonData, fileName = "data.xlsx") {
            // 1. Create a new workbook
            const wb = XLSX.utils.book_new();

            // 2. Convert JSON data to a worksheet
            const ws = XLSX.utils.json_to_sheet(jsonData);

            // 3. Append the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            // 4. Write the workbook to a file
            XLSX.writeFile(wb, fileName);
        }

        // Event listener for export button
        document.getElementById('exportData').addEventListener('click', () => {
            if (!processedData || !processedData.employeeList.length) {
                alert("No data to export. Please upload a file first.");
                return;
            }
            function cloneEmployeesData(employeesData) {
                return employeesData.map(employee => {
                    return {
                        "Employee ID": employee.id,
                        "Job Level": employee.job_level,
                        "Line Manager": employee.line_manager,
                        "Home Postcode": employee.zip_code,
                        "Home Latitude": employee.latitude,
                        "Home Longitude": employee.longitude,
                        ...employee.offices.reduce((acc, office) => {
                            acc[office.id] = office.zip_code;
                            return acc;
                        }, {}),
                    };
                });
            }
            const employeesData = cloneEmployeesData(processedData.employeeList);
            exportJsonToExcel(employeesData, "EmployeeData.xlsx");
        });

        /**
         * Retrieves the Google Maps API Key from localStorage or prompts the user.
         * @returns {Promise<string>} The API Key.
         */
        async function getApiKey() {
            let apiKey = localStorage.getItem("GoogleMapsAPIKey");
            if (!apiKey) {
                apiKey = prompt("Please enter your Google Maps API Key:");
                if (!apiKey) {
                    alert("API Key is required. Please try again.");
                    throw new Error("INVALID_API_KEY");
                }
                localStorage.setItem("GoogleMapsAPIKey", apiKey);
            }
            return apiKey;
        }

        /**
         * Initializes the UI by fetching the API Key and loading the map.
         */
        async function showUI() {
            try {
                const apiKey = await getApiKey();
                mapContainer.style.display = "flex";
                await loadGoogleMapsScript(apiKey);
            } catch (error) {
                console.error("Failed to load the UI:", error);
            }
        }

        /**
         * Dynamically loads the Google Maps script.
         * @param {string} apiKey - The Google Maps API Key.
         * @returns {Promise<void>}
         */
        function loadGoogleMapsScript(apiKey) {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry`;
                script.async = true;
                script.defer = true;
                script.onerror = () => reject(new Error("Failed to load Google Maps script."));
                window.initMap = () => {
                    initializeMap();
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        /**
         * Initializes the Google Map and related services.
         */
        function initializeMap() {
            googleMap = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 20.5937, lng: 78.9629 }, // Default center (India)
                zoom: 5,
                mapTypeId: "terrain",
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(googleMap);

            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(googleMap);
        }

        /**
         * Handles the file upload event.
         * @param {Event} event - The file input change event.
         */
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await readExcelFile(file);
                processedData = await processWorkbook(data);
                console.info("Processed data:", processedData);
                plotLocations(processedData);
            } catch (error) {
                console.error("Error processing file:", error);
                alert("Failed to process the uploaded file. Please check the console for details.");
            }
        }

        /**
         * Reads the Excel file and returns the workbook data.
         * @param {File} file - The uploaded Excel file.
         * @returns {Promise<Array<Object>>} The merged data from all sheets.
         */
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const mergedData = [];
                        workbook.SheetNames.forEach((sheetName) => {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet);
                            mergedData.push(...jsonData);
                        });
                        resolve(mergedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error("Failed to read the file."));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * Processes the workbook data to extract employee and office information.
         * @param {Array<Object>} data - The merged data from all sheets.
         * @returns {Promise<{ employeeList: Array<Object>, officeList: Array<Object> }>} The processed data.
         */
        async function processWorkbook(data) {
            const employeeList = [];
            const officeList = [];

            const officeIds = [
                'Birmingham Office Postcode',
                'Caithness Office Postcode',
                'Cardiff Office Postcode',
                'Cheadle Office Postcode',
                'Crawley Office Postcode',
                'Exeter Office Postcode',
                'Lancing Office Postcode',
                'Leeds Office Postcode',
                'Liverpool Office Postcode',
                'London Office Postcode',
                'Reading Office Postcode',
                'Worthing Office Postcode',
                'Milwaukee Office Postcode',
                'Minnesota Office Postcode',
                'New York Office Postcode',
                'RPK Office Postcode',
                'Conshohocken Office Postcode',
            ];

            for (const row of data) {
                try {
                    const homeLocation = await getLocationFromZipCode(row['Home Postcode']);
                    if (!homeLocation) {
                        console.warn(`Invalid Home Postcode for Employee ID: ${row['Employee ID']}`);
                        continue;
                    }

                    const employee = {
                        id: row['Employee ID'],
                        job_level: row['Job Level'],
                        line_manager: row['Line Manager'],
                        zip_code: row['Home Postcode'],
                        latitude: homeLocation.latitude,
                        longitude: homeLocation.longitude,
                        offices: [],
                    };
                    employeeList.push(employee);

                    // Process each office postcode for the current employee
                    for (const officeId of officeIds) {
                        const officeZip = row[officeId];
                        if (officeZip) {
                            const office = officeList.find((o) => o.id === officeId);
                            if (!office) {
                                const officeLocation = await getLocationFromZipCode(officeZip);
                                if (!officeLocation) {
                                    console.warn(`Invalid Zip Code for ${officeId}: ${officeZip}`);
                                }

                                const office = {
                                    id: officeId,
                                    zip_code: officeZip,
                                    latitude: officeLocation && officeLocation.latitude,
                                    longitude: officeLocation && officeLocation.longitude,
                                    employees: [],
                                };
                                officeList.push(office);
                                office.employees.push(employee);
                                employee.offices.push(office);
                            } else {
                                office.employees.push(employee);
                                employee.offices.push(office);
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Error processing row for Employee ID: ${row['Employee ID']}`, error);
                }
            }

            return { employeeList, officeList };
        }

        /**
         * Retrieves the geographical location for a given zip code.
         * @param {string} zipCode - The postal code.
         * @returns {Promise<{ latitude: number, longitude: number } | null>} The location or null if not found.
         */
        function getLocationFromZipCode(zipCode) {
            return new Promise((resolve, reject) => {
                if (!zipCode) {
                    resolve(null);
                    return;
                }
                const latlan = localStorage.getItem(`zip_code-${zipCode}`);
                if (latlan) {
                    const [latitude, longitude] = latlan.split(',');
                    resolve({ latitude: parseFloat(latitude), longitude: parseFloat(longitude) });
                    return;
                }

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: zipCode.toString() }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        const location = results[0].geometry.location;
                        const latlanJSON = {
                            latitude: location.lat(),
                            longitude: location.lng(),
                        };
                        localStorage.setItem(`zip_code-${zipCode}`, `${latlanJSON.latitude},${latlanJSON.longitude}`);
                        resolve(latlanJSON);
                    } else {
                        console.warn(`Geocode failed for zip code ${zipCode}: ${status}`);
                        resolve(null);
                    }
                });
            });
        }

        /**
         * Plots employee and office locations on the map and creates office buttons.
         * @param {{ employeeList: Array<Object>, officeList: Array<Object> }} data - The processed data.
         */
        function plotLocations(data) {
            // Clear previous markers and buttons if any
            officeButtonsContainer.innerHTML = '';
            // Optionally, you can keep track of markers to clear them later

            data.officeList.forEach((office) => {
                if (!office.latitude || !office.longitude) {
                    console.warn(`Skipping office ${office.id} due to missing location data.`);
                    return;
                }
                const officeLatLng = { lat: office.latitude, lng: office.longitude };

                // Create a button for the office
                const officeButton = document.createElement("button");
                officeButton.className = "office-btn";
                officeButton.textContent = office.id.replace(' Office Postcode', '');
                officeButton.addEventListener("click", () => focusOnOffice(officeLatLng));
                officeButtonsContainer.appendChild(officeButton);

                // Draw a circle around the office to represent the area (optional)
                new google.maps.Circle({
                    strokeColor: "#0000FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#0000FF",
                    fillOpacity: 0.1,
                    map: googleMap,
                    center: officeLatLng,
                    radius: 160934, // 100 miles in meters
                });

                // Add an office marker
                new google.maps.Marker({
                    position: officeLatLng,
                    map: googleMap,
                    icon: {
                        url: "https://maps.google.com/mapfiles/kml/shapes/schools_maps.png", // Custom Office Icon
                        scaledSize: new google.maps.Size(30, 30),
                    },
                    title: office.id.replace(' Office Postcode', ''),
                });

                // Plot employee markers
                office.employees.forEach((employee) => {
                    const employeeLatLng = { lat: employee.latitude, lng: employee.longitude };
                    const markerColor = getDistanceColor(employee, office);

                    const employeeMarker = new google.maps.Marker({
                        position: employeeLatLng,
                        map: googleMap,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 6,
                            fillColor: markerColor,
                            fillOpacity: 1,
                            strokeWeight: 1,
                            strokeColor: "white",
                        },
                        title: `Employee ID: ${employee.id}`,
                    });

                    // Add click event to show route and travel time
                    employeeMarker.addListener("click", () => {
                        showRouteAndTime(employeeLatLng, officeLatLng);
                    });
                });
            });
        }

        /**
         * Determines the color of the employee marker based on distance or other criteria.
         * @param {Object} employee - The employee object.
         * @param {Object} office - The office object.
         * @returns {string} The color code.
         */
        function getDistanceColor(employee, office) {
            // Placeholder for distance-based coloring logic
            // For example, green for nearby, red for far
            // You can implement actual distance calculations here
            return "green";
        }

        /**
         * Displays the route and travel time between two locations on the map.
         * @param {{ lat: number, lng: number }} origin - The starting point.
         * @param {{ lat: number, lng: number }} destination - The ending point.
         */
        async function showRouteAndTime(origin, destination) {
            const start = new google.maps.LatLng(origin.lat, origin.lng);
            const end = new google.maps.LatLng(destination.lat, destination.lng);

            try {
                const response = await directionsService.route({
                    origin: start,
                    destination: end,
                    travelMode: "DRIVING", // Changed to a valid travel mode
                });

                directionsRenderer.setDirections(response);

                const leg = response.routes[0].legs[0];
                travelInfo.textContent = `Travel time: ${leg.duration.text}, Distance: ${leg.distance.text}`;
            } catch (error) {
                console.error("Directions request failed:", error);
                alert("Failed to retrieve directions. Please try again.");
            }
        }

        /**
         * Focuses the map on a specific office location.
         * @param {{ lat: number, lng: number }} officeLatLng - The office location.
         */
        function focusOnOffice(officeLatLng) {
            googleMap.setCenter(officeLatLng);
            googleMap.setZoom(10); // Adjust zoom level as needed
        }

        // Event Listeners
        document.addEventListener("DOMContentLoaded", showUI);
        fileInput.addEventListener("change", handleFileUpload);
    </script>
</body>

</html>
