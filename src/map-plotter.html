<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Office Map</title>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        #map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #travel-info {
            padding: 10px;
            font-size: 14px;
            background-color: #f0f0f0;
        }

        #map {
            flex-grow: 1;
            /* Allow map to grow and fill remaining space */
            width: 100%;
        }

        .office-btn {
            margin: 5px;
            padding: 10px;
            background-color: lightblue;
            border: none;
            cursor: pointer;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <h1>Upload Excel File to Plot Employee and Office Locations</h1>
    <div id="map-container" style="display: none">
        <input type="file" id="fileInput" accept=".xlsx" />
        <div id="officeButtons"></div>
        <div id="travel-info"></div>
        <!-- Travel time and route info -->
        <div id="map"></div>
    </div>

    <script>
        let map;
        let officeButtons = {};
        let directionsService;
        let directionsRenderer;
        let trafficLayer;

        function getApiKey() {
            return new Promise((resolve, reject) => {
                let apiKey = window.localStorage.getItem("GoogleMapsAPIKey");
                if (!apiKey) {
                    apiKey = window.prompt(
                        "Please enter your Google Maps API Key:",
                        ""
                    );
                    if (!apiKey) {
                        window.alert("API Key is required. Please try again.");
                        reject("INVALID_API_KEY");
                    } else {
                        window.localStorage.setItem("GoogleMapsAPIKey", apiKey);
                        resolve(apiKey);
                    }
                } else {
                    resolve(apiKey);
                }
            });
        }

        function showUI() {
            getApiKey()
                .then((apiKey) => {
                    const body = document.body;
                    document.getElementById("map-container").style.display = "flex"; // Show the map view

                    initMap(apiKey);
                })
                .catch((error) => {
                    console.error("Failed to load the UI:", error);
                });
        }

        function initMap(apiKey) {
            if (!apiKey) {
                window.alert("API Key is required. Please try again.");
                return;
            }

            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initCallback&libraries=geometry`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        function initCallback() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 20.5937, lng: 78.9629 }, // Default center (India)
                zoom: 5,
                mapTypeId: "terrain",
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);
        }

        document
            .getElementById("fileInput")
            .addEventListener("change", handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    processWorkbook(workbook);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function processWorkbook(workbook) {
            const mergedData = [];
            workbook.SheetNames.forEach((sheetName) => {
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                mergedData.push(...jsonData);
            });
            processData(mergedData).then((processedData) => {
                console.info("Processed data:", processedData);
                plotLocations(processedData);
            });
        }

        function processData(data) {
            return new Promise((resolve, reject) => {
                const employeeList = [];
                const officeList = [];

                data.forEach((row) => {
                    getLocationFromZipCode(row['Home Postcode']).then((location) => {
                        console.log('location:', location._latitude, location._longitude);
                        const home_lat = location._latitude;
                        const home_lon = location._longitude;
                        const employee = {
                            id: row['Employee ID'],
                            zip_code: row['Home Postcode'],
                            ...location,
                        };
                        const offices = [];
                        employeeList.push({
                            ...employee,
                            offices,
                        });

                        const officeIds = [
                            'Birmingham Office Postcode',
                            'Caithness Office Postcode',
                            'Cardiff Office Postcode',
                            'Cheadle Office Postcode',
                            'Crawley Office Postcode',
                            'Exeter Office Postcode',
                            'Lancing Offcie Postcode',
                            'Leeds Office Postcode',
                            'Liverpool Office Postcode',
                            'London Office Postcode',
                            'Reading Office Postcode',
                            'Worthing Office Postcode',
                            'Milwaukee Office Postcode',
                            'Minnesota Office Postcode',
                            'New York Office Postcode',
                            'RPK Office Postcode',
                            'Conshohocken Office Postcode',
                        ];

                        const promises = [];
                        officeIds.forEach((officeId) => {
                            const officeZipCode = row[officeId];
                            if (officeZipCode) {
                                promises.push(getLocationFromZipCode(officeZipCode));
                                offices.push({
                                    id: officeId,
                                    zip_code: officeZipCode,
                                });
                            }
                        });
                        Promise.all(promises).then((locations) => {
                            locations.forEach((location, index) => {
                                if (!location) {
                                    return;
                                }
                                const ofc = offices[index];
                                ofc._latitude = location._latitude;
                                ofc._longitude = location._longitude;
                                ofc._lat_lang = location._lat_lang;

                                const office = officeList.find((o) => o.id === ofc.id);
                                if (office) {
                                    office.employees.push(employee);
                                } else {
                                    const office = {
                                        ...ofc,
                                        employees: [employee],
                                    };
                                    officeList.push(office);
                                }
                            });

                            resolve({
                                employeeList,
                                officeList,
                            });
                        }).catch((error) => {
                            console.error(error);
                        });
                    }).catch((error) => {
                        console.error(error);
                    });
                });
            });
        }

        function getLocationFromZipCode(zipCode) {
            return new Promise((resolve, reject) => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: String(zipCode) }, (results, status) => {
                    if (status === "OK") {
                        const location = results[0].geometry.location;
                        resolve({
                            _lat_lan: location,
                            _latitude: location.lat(),
                            _longitude: location.lng(),
                        });
                    } else {
                        resolve();
                        // reject("Geocode was not successful for the following reason: " + status);
                    }
                });
            });
        }

        function plotLocations(data) {
            // Plot employee home locations and create office buttons
            data.officeList.forEach((office) => {
                const officeLat = office._latitude;
                const officeLon = office._longitude;
                const maxMiles = 100; // Maximum distance in miles
                const maxMinutes = 1000; // Maximum travel time in minutes

                calculateMaxDistance(
                    office,
                    office.employees,
                    maxMiles,
                    maxMinutes,
                    (nearbyEmployees = [], faroffEmployees = []) => {
                        const maxDistance = nearbyEmployees.length > 0 && getMaxDistance(
                            new google.maps.LatLng(office._latitude, office._longitude),
                            nearbyEmployees
                        ) || 0;

                        // Create a button for each office
                        const officeButton = document.createElement("button");
                        officeButton.className = "office-btn";
                        officeButton.textContent = `Office ${office.id}`;
                        officeButton.onclick = () =>
                            focusOnOffice(officeLat, officeLon, maxDistance);
                        document
                            .getElementById("officeButtons")
                            .appendChild(officeButton);

                        if (nearbyEmployees.length > 0) {
                            // Plot office circle dynamically based on the farthest employee
                            new google.maps.Circle({
                                strokeColor: "#0000FF",
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: "#0000FF",
                                fillOpacity: 0.45,
                                map: map,
                                center: { lat: officeLat, lng: officeLon },
                                radius: maxDistance, // Dynamic radius to include all employees
                            });
                        }

                        // Plot employee home locations
                        nearbyEmployees.forEach((employee) => {
                            const employeeMarker = new google.maps.Marker({
                                position: { lat: employee._latitude, lng: employee._longitude },
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 4,
                                    fillColor: "green",
                                    fillOpacity: 1,
                                    strokeWeight: 1,
                                    strokeColor: "white",
                                },
                            });

                            // Add click event to each employee marker
                            employeeMarker.addListener("click", () => {
                                showRouteAndTime(
                                    employee._latitude,
                                    employee._longitude,
                                    officeLat,
                                    officeLon
                                );
                            });
                        });

                        faroffEmployees.forEach((employee) => {
                            const employeeMarker = new google.maps.Marker({
                                position: { lat: employee._latitude, lng: employee._longitude },
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 4,
                                    fillColor: "red",
                                    fillOpacity: 1,
                                    strokeWeight: 1,
                                    strokeColor: "white",
                                },
                            });
                        });

                        // Plot the office location with a small office icon
                        new google.maps.Marker({
                            position: { lat: officeLat, lng: officeLon },
                            map: map,
                            icon: {
                                url: "https://maps.google.com/mapfiles/kml/shapes/schools_maps.png", // Office icon
                                scaledSize: new google.maps.Size(30, 30), // Scale the office icon
                            },
                        });
                    }
                );
            });
        }

        function calculateMaxDistance(
            office,
            employees,
            maxMiles,
            maxMinutes,
            callback
        ) {
            const officeLatLng = new google.maps.LatLng(office._latitude, office._longitude);
            const maxDistanceMeters = maxMiles * 1609.34; // Convert miles to meters

            let filteredEmployees = employees.filter((employee) => {
                const employeeLatLng = new google.maps.LatLng(
                    employee._latitude,
                    employee._longitude
                );
                const distance =
                    google.maps.geometry.spherical.computeDistanceBetween(
                        officeLatLng,
                        employeeLatLng
                    );
                return maxMiles === 0 || distance <= maxDistanceMeters; // Include if maxMiles is 0 (no limit) or within maxMiles
            });

            if (maxMinutes > 0) {
                // If maxMinutes is provided, filter by travel time
                const directionsRequests = filteredEmployees.map((employee) => {
                    return new Promise((resolve, reject) => {
                        const employeeLatLng = new google.maps.LatLng(
                            employee._latitude,
                            employee._longitude
                        );
                        directionsService.route(
                            {
                                origin: employeeLatLng,
                                destination: officeLatLng,
                                travelMode: "DRIVING",
                            },
                            (response, status) => {
                                if (status === "OK") {
                                    const travelTime =
                                        response.routes[0].legs[0].duration.value / 60; // Convert seconds to minutes
                                    resolve({ employee, travelTime });
                                } else {
                                    reject("Directions request failed");
                                }
                            }
                        );
                    });
                });

                Promise.all(directionsRequests)
                    .then((results) => {
                        // Filter employees who satisfy both maxMinutes and maxMiles criteria
                        filteredEmployees = results
                            .filter(
                                (result) =>
                                    maxMinutes === 0 || result.travelTime <= maxMinutes
                            )
                            .map((result) => result.employee);

                        const nearbyEmployees = filteredEmployees;
                        const faroffEmployees = employees.filter((employee) => {
                            return !nearbyEmployees.some((e) => e.id === employee.id);
                        });

                        callback(nearbyEmployees, faroffEmployees); // Use a callback to return asynchronously
                    })
                    .catch((error) => {
                        console.error(error);
                        callback(); // In case of an error, return 0 distance
                    });
            } else {
                // If no maxMinutes, calculate max distance based only on maxMiles
                new Promise(() => Promise.resolve()).then(() => {
                    const nearbyEmployees = filteredEmployees;
                    const faroffEmployees = employees.filter((employee) => {
                        return !nearbyEmployees.some((e) => e.id === employee.id);
                    });
                    callback(nearbyEmployees, faroffEmployees); // Use a callback to return asynchronously
                });
            }
        }

        function getMaxDistance(officeLatLng, employees) {
            let maxDistance = 0;
            employees.forEach((employee) => {
                const employeeLatLng = new google.maps.LatLng(
                    employee._latitude,
                    employee._longitude
                );
                const distance =
                    google.maps.geometry.spherical.computeDistanceBetween(
                        officeLatLng,
                        employeeLatLng
                    );
                if (distance > maxDistance) {
                    maxDistance = distance;
                }
            });
            return maxDistance;
        }

        function showRouteAndTime(startLat, startLng, endLat, endLng) {
            const start = new google.maps.LatLng(startLat, startLng);
            const end = new google.maps.LatLng(endLat, endLng);

            directionsService.route(
                {
                    origin: start,
                    destination: end,
                    travelMode: "TWO_WHEELER",
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);

                        // Extract and show the travel time from the response
                        const travelInfo = response.routes[0].legs[0];
                        document.getElementById(
                            "travel-info"
                        ).textContent = `Travel time: ${travelInfo.duration.text}, Distance: ${travelInfo.distance.text}`;
                    } else {
                        console.error("Directions request failed due to " + status);
                    }
                }
            );
        }

        function focusOnOffice(lat, lon, radius) {
            const officeLatLng = new google.maps.LatLng(lat, lon);

            // Create bounds based on the radius
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(
                google.maps.geometry.spherical.computeOffset(officeLatLng, radius, 0)
            ); // North
            bounds.extend(
                google.maps.geometry.spherical.computeOffset(officeLatLng, radius, 90)
            ); // East
            bounds.extend(
                google.maps.geometry.spherical.computeOffset(
                    officeLatLng,
                    radius,
                    180
                )
            ); // South
            bounds.extend(
                google.maps.geometry.spherical.computeOffset(
                    officeLatLng,
                    radius,
                    270
                )
            ); // West

            // Adjust the map to fit the bounds
            map.fitBounds(bounds);
        }

        document.addEventListener("DOMContentLoaded", showUI);
    </script>
</body>

</html>