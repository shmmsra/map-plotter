<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Office Map</title>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        .header {
            padding: 4px 16px 4px 16px;
            background-color: #4a90e2;
            color: white;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            font-size: 16px;
        }

        .header h2 {
            margin: 12px 0;
        }

        #map-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
        }

        #controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .file-input {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .file-input .btn {
            width: 128px;
            text-align: end;
        }

        .control-btn {
            font-size: 12px;
            padding: 10px;
            background-color: lightcoral;
            border: none;
            cursor: pointer;
        }

        .export-btn {
            background-color: lightgreen;
        }

        #fileSelector {
            display: flex;
            flex-direction: column;
        }

        #officeButtons {
            display: flex;
            flex-wrap: wrap;
            background-color: whitesmoke;
            border-bottom: 2px solid #4a90e2;
        }

        .office-btn {
            font-size: 12px;
            padding: 8px;
            margin: 4px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .office-btn:hover {
            background-color: #357ab8;
        }

        #map {
            flex-grow: 1;
            width: 100%;
        }
    </style>

    <!-- XLSX Library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <header class="header">
        <div id="title">
            <h2>Employee Office Map</h2>
            <div class="file-input">
                <input type="file" id="employeeFileInput" accept=".xlsx" />
            </div>
        </div>
        <div id="controls">
            <button id="resetApiKey" class="control-btn">Reset API Key</button>
            <button id="processData" class="control-btn export-btn">Process Data</button>
            <button id="exportData" class="control-btn export-btn">Export Data</button>
            <div id="fileSelector">
                <div class="file-input">
                    <label for="zipCodeFileInput" class="btn">ZipCode Data</label>
                    <input type="file" id="zipCodeFileInput" accept=".xlsx,.json" />
                </div>
                <div class="file-input">
                    <label for="mapsFileInput" class="btn">Maps Data</label>
                    <input type="file" id="mapsFileInput" accept=".xlsx,.json" />
                </div>
            </div>
        </div>
    </header>
    <div id="officeButtons"></div>
    <div id="map-container" style="display: none;">
        <div id="map"></div>
    </div>

    <script>
        // Global Store
        const LocalStorage = (function () {
            class LocalStorage {
                storage = {};

                constructor() {
                    const globalStr = localStorage.getItem("global");
                    if (globalStr) {
                        this.storage['global'] = JSON.parse(globalStr);
                    } else {
                        this.storage['global'] = {};
                    }

                    const zipCodeLocationMapStr = localStorage.getItem("zipCodeLocationMap");
                    if (zipCodeLocationMapStr) {
                        this.storage['zipCodeLocationMap'] = JSON.parse(zipCodeLocationMapStr);
                    } else {
                        this.storage['zipCodeLocationMap'] = {};
                    }

                    const zipCodeDistanceMatrixStr = localStorage.getItem("zipCodeDistanceMatrix");
                    if (zipCodeDistanceMatrixStr) {
                        this.storage['zipCodeDistanceMatrix'] = JSON.parse(zipCodeDistanceMatrixStr);
                    } else {
                        this.storage['zipCodeDistanceMatrix'] = {};
                    }

                    const zipCodeTimeMatrixStr = localStorage.getItem("zipCodeTimeMatrix");
                    if (zipCodeTimeMatrixStr) {
                        this.storage['zipCodeTimeMatrix'] = JSON.parse(zipCodeTimeMatrixStr);
                    } else {
                        this.storage['zipCodeTimeMatrix'] = {};
                    }
                }

                getItems(category, key) {
                    return this.storage[category][key];
                }

                setItems(category, key, value) {
                    this.storage[category][key] = value;
                }

                save() {
                    localStorage.setItem("global", JSON.stringify(this.storage['global']));
                    localStorage.setItem("zipCodeLocationMap", JSON.stringify(this.storage['zipCodeLocationMap']));
                    localStorage.setItem("zipCodeDistanceMatrix", JSON.stringify(this.storage['zipCodeDistanceMatrix']));
                    localStorage.setItem("zipCodeTimeMatrix", JSON.stringify(this.storage['zipCodeTimeMatrix']));
                }

                clear() {
                    this.storage = {};
                    localStorage.removeItem("global");
                    localStorage.removeItem("zipCodeLocationMap");
                    localStorage.removeItem("zipCodeDistanceMatrix");
                    localStorage.removeItem("zipCodeTimeMatrix");
                }
            };
            return new LocalStorage();
        })();

        // Global Variables
        let googleMap;
        let directionsService;
        let directionsRenderer;
        let trafficLayer;
        let processedData;
        let zipCodeDistanceMatrix;
        let zipCodeLocationMap;
        let zipCodeDistanceAndTimeMatrix;
        let radiusMilesThreshold = 40 * 1609.34; // Default radius in meters
        let travelTimeThreshold = 60 * 60; // Default travel time in seconds

        // Cache DOM Elements
        const mapContainer = document.getElementById('map-container');
        const zipCodeFileInput = document.getElementById('zipCodeFileInput');
        const officeButtonsContainer = document.getElementById('officeButtons');

        // Event listener for reset button
        document.getElementById('resetApiKey').addEventListener('click', () => {
            LocalStorage.clear();
            window.location.reload();
        });

        // Event listener for process button
        document.getElementById('processData').addEventListener('click', () => {
            handleFileUpload();
        });

        // Function to export JSON data to Excel
        function exportJsonToExcel(jsonData, fileName = "data.xlsx") {
            // 1. Create a new workbook
            const wb = XLSX.utils.book_new();

            // 2. Convert JSON data to a worksheet
            const ws = XLSX.utils.json_to_sheet(jsonData);

            // 3. Append the worksheet to the workbook
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            // 4. Write the workbook to a file
            XLSX.writeFile(wb, fileName);
        }

        // Event listener for export button
        document.getElementById('exportData').addEventListener('click', () => {
            if (!processedData || !processedData.employeeList.length) {
                alert("No data to export. Please upload a file first.");
                return;
            }
            function cloneEmployeesData(employeesData) {
                return employeesData.map(employee => {
                    return {
                        "Employee ID": employee.id,
                        "Job Level": employee.job_level,
                        "Line Manager": employee.line_manager,
                        "Home Postcode": employee.zip_code,
                        "Home Latitude": employee.latitude,
                        "Home Longitude": employee.longitude,
                        ...employee.offices.reduce((acc, office) => {
                            acc[office.id] = office.zip_code;
                            return acc;
                        }, {}),
                    };
                });
            }
            const employeesData = cloneEmployeesData(processedData.employeeList);
            exportJsonToExcel(employeesData, "EmployeeData.xlsx");
        });

        /**
         * Retrieves the Google Maps API Key from LocalStorage or prompts the user.
         * @returns {Promise<string>} The API Key.
         */
        async function getApiKey() {
            let apiKey = LocalStorage.getItems('global', 'GoogleMapsAPIKey');
            if (!apiKey) {
                apiKey = prompt("Please enter your Google Maps API Key:");
                if (!apiKey) {
                    alert("API Key is required. Please try again.");
                    throw new Error("INVALID_API_KEY");
                }
                LocalStorage.setItems('global', 'GoogleMapsAPIKey', apiKey);
            }
            return apiKey;
        }

        /**
         * Initializes the UI by fetching the API Key and loading the map.
         */
        async function showUI() {
            try {
                const apiKey = await getApiKey();
                LocalStorage.save();
                mapContainer.style.display = "flex";
                await loadGoogleMapsScript(apiKey);
            } catch (error) {
                console.error("Failed to load the UI:", error);
            }
        }

        /**
         * Dynamically loads the Google Maps script.
         * @param {string} apiKey - The Google Maps API Key.
         * @returns {Promise<void>}
         */
        function loadGoogleMapsScript(apiKey) {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }
                const script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry`;
                script.async = true;
                script.defer = true;
                script.onerror = () => reject(new Error("Failed to load Google Maps script."));
                window.initMap = () => {
                    initializeMap();
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        /**
         * Initializes the Google Map and related services.
         */
        function initializeMap() {
            googleMap = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 20.5937, lng: 78.9629 }, // Default center (India)
                zoom: 5,
                mapTypeId: "terrain",
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(googleMap);

            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(googleMap);
        }

        /**
         * Handles the file upload event.
         * @param {Event} event - The file input change event.
         */
        async function handleFileUpload() {
            try {
                const data = await readFile('employeeFileInput');
                if (!data || !data.length) {
                    alert("No data found in the uploaded file.");
                    throw new Error("No data found in the uploaded file.");
                }

                zipCodeLocationMap = await readFile('zipCodeFileInput');
                zipCodeLocationMap.forEach((d) => {
                    d.zipCode = String(d.zipCode).split(' ').join('').toUpperCase();
                    d.latitude = parseFloat(d.latitude);
                    d.longitude = parseFloat(d.longitude);
                });

                zipCodeDistanceAndTimeMatrix = await readFile('mapsFileInput');
                zipCodeDistanceAndTimeMatrix.forEach((d) => {
                    d.key = String(d.key);
                    d.source = String(d.source).split(' ').join('').toUpperCase();
                    d.destination = String(d.destination).split(' ').join('').toUpperCase();
                    d.aerialDistance = parseFloat(d.aerialDistance);
                    d.drivingDistance = parseFloat(d.drivingDistance);
                    d.drivingTime = parseFloat(d.drivingTime);
                    d.bicycleDistance = parseFloat(d.bicycleDistance);
                    d.bicycleTime = parseFloat(d.bicycleTime);
                });

                radiusMilesThreshold = prompt("Please enter the office radius threshold in miles:") * 1609.34;
                travelTimeThreshold = prompt("Please enter the travel time threshold in minutes:") * 60;

                processedData = await processWorkbook(data);
                console.info("Processed data:", processedData);

                await plotOfficeLocations(processedData.officeList);
                await plotEmployeeLocations(processedData.employeeList);

                LocalStorage.save();
            } catch (error) {
                console.error("Error processing file:", error);
                alert("Failed to process the uploaded file. Please check the console for details.");
            }
        }

        /**
         * Reads the Excel file and returns the workbook data.
         * @param {File} file - The uploaded Excel file.
         * @returns {Promise<Array<Object>>} The merged data from all sheets.
         */
        function readExcelFile() {
            return new Promise((resolve, reject) => {
                const input = document.getElementById('zipCodeFileInput');
                const file = input.files[0];
                if (!file) {
                    reject(new Error("No file selected."));
                };

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const mergedData = [];
                        workbook.SheetNames.forEach((sheetName) => {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet);
                            mergedData.push(...jsonData);
                        });
                        resolve(mergedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error("Failed to read the file."));
                reader.readAsArrayBuffer(file);
            });
        }

        function readFile(inputId) {
            return new Promise((resolve, reject) => {
                const input = document.getElementById(inputId);
                const file = input.files[0];
                const reader = new FileReader();
                let fileType = '';

                // When the file is successfully read
                reader.onload = function (event) {
                    try {
                        if (fileType === 'excel') {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                            resolve(jsonData);
                        } else if (fileType === 'json') {
                            const json = JSON.parse(event.target.result);
                            resolve(json);
                        }
                    } catch (e) {
                        alert('Error parsing JSON file.');
                        reject(error);
                    }
                };

                if (!file) {
                    alert('Please select a Excel or JSON file first.');
                    return;
                } else if (file.type.includes('officedocument')) {
                    // Read the file as a bytes array
                    reader.readAsArrayBuffer(file);
                    fileType = 'excel';
                } else if (file.type.includes('json')) {
                    // Read the file as a text string
                    reader.readAsText(file);
                    fileType = 'json';
                } else {
                    alert('Please select a Excel or JSON file first.');
                    return;
                }
            });
        }

        /**
         * Processes the workbook data to extract employee and office information.
         * @param {Array<Object>} data - The merged data from all sheets.
         * @returns {Promise<{ employeeList: Array<Object>, officeList: Array<Object> }>} The processed data.
         */
        async function processWorkbook(data) {
            const employeeList = [];
            const officeList = [];

            const officeIds = [
                'Birmingham Office Postcode',
                'Caithness Office Postcode',
                'Cardiff Office Postcode',
                'Cheadle Office Postcode',
                'Crawley Office Postcode',
                'Exeter Office Postcode',
                'Lancing Office Postcode',
                'Leeds Office Postcode',
                'Liverpool Office Postcode',
                'London Office Postcode',
                'Reading Office Postcode',
                'Worthing Office Postcode',
                'Milwaukee Office Postcode',
                'Minnesota Office Postcode',
                'New York Office Postcode',
                'RPK Office Postcode',
                'Conshohocken Office Postcode',
            ];

            for (const row of data) {
                try {
                    const homeLocation = await getLocationFromZipCode(row['Home Postcode']);
                    if (!homeLocation) {
                        console.warn(`Invalid Home Postcode for Employee ID: ${row['Employee ID']}`);
                        continue;
                    }

                    const employee = {
                        id: row['Employee ID'],
                        job_level: row['Job Level'],
                        line_manager: row['Line Manager'],
                        zip_code: String(row['Home Postcode']).split(' ').join('').toUpperCase(),
                        latitude: homeLocation.latitude,
                        longitude: homeLocation.longitude,
                        address: homeLocation.address,
                        offices: [],
                    };
                    employeeList.push(employee);

                    // Process each office postcode for the current employee
                    for (const officeId of officeIds) {
                        const officeZip = row[officeId];
                        if (officeZip) {
                            let office = officeList.find((o) => o.id === officeId);
                            if (!office) {
                                const officeLocation = await getLocationFromZipCode(officeZip);
                                if (!officeLocation) {
                                    console.warn(`Invalid Zip Code for ${officeId}: ${officeZip}`);
                                }

                                office = {
                                    id: officeId,
                                    zip_code: String(officeZip).split(' ').join('').toUpperCase(),
                                    latitude: officeLocation && officeLocation.latitude,
                                    longitude: officeLocation && officeLocation.longitude,
                                    address: officeLocation && officeLocation.address,
                                    employees: [],
                                };
                                officeList.push(office);
                            }
                            office.employees.push(employee);
                            employee.offices.push(office);
                        }
                    }
                } catch (error) {
                    console.error(`Error processing row for Employee ID: ${row['Employee ID']}`, error);
                }
            }

            LocalStorage.save();

            await Promise.all(officeList.map(async (office) => {
                if (!office.latitude || !office.longitude) {
                    console.warn(`Skipping office ${office.id} due to missing location data.`);
                    return;
                }

                await Promise.all(office.employees.map(async (employee) => {
                    const isGoodMatch = await isEmployeeOfficeGoodMatch(employee, office);

                    employee.nearByOffices = employee.nearByOffices || [];
                    office.nearByEmployees = office.nearByEmployees || [];
                    if (isGoodMatch) {
                        employee.nearByOffices.push(office);
                        office.nearByEmployees.push(employee);
                    }
                }));
            }));

            LocalStorage.save();
            return { employeeList, officeList };
        }

        /**
         * Retrieves the geographical location for a given zip code.
         * @param {string} zipCode - The postal code.
         * @returns {Promise<{ latitude: number, longitude: number } | null>} The location or null if not found.
         */
        function getLocationFromZipCode(zipCode) {
            return new Promise((resolve, reject) => {
                if (!zipCode) {
                    resolve(null);
                    return;
                }
                zipCode = String(zipCode).split(' ').join('').toUpperCase();
                if (!zipCode) {
                    resolve(null);
                    return;
                }

                const data = zipCodeLocationMap.find((d) => d.zipCode === zipCode);
                if (!data) {
                    resolve(null);
                    return;
                }
                resolve(data);
            });
        }

        function getShortestDistance(originZipCode, destinationZipCode) {
            return new Promise((resolve, reject) => {
                try {
                    const origin = originZipCode.split(' ').join('').toUpperCase();
                    const destination = destinationZipCode.split(' ').join('').toUpperCase();
                    const data = zipCodeDistanceAndTimeMatrix.find((d) => d.source === origin && d.destination === destination);
                    if (!data) {
                        resolve(Infinity);
                    }

                    const { aerialDistance, drivingDistance, drivingTime, bicycleDistance, bicycleTime } = data;
                    resolve(aerialDistance);
                } catch (error) {
                    console.error("Failed to get shortest distance:", error);
                    resolve(Infinity);
                }
            });
        }

        /**
         * Plots office locations on the map and creates office buttons.
         * @param {{ officeList: Array<Object> }} data - The processed data.
         */
        async function plotOfficeLocations(officeList) {
            // Clear previous markers and buttons if any
            officeButtonsContainer.innerHTML = '';
            // Optionally, you can keep track of markers to clear them later

            await Promise.all(officeList.map(async (office) => {
                try {
                    if (!office.latitude || !office.longitude) {
                        console.warn(`Skipping office ${office.id} due to missing location data.`);
                        return;
                    }
                    const officeLatLng = { lat: parseFloat(office.latitude), lng: parseFloat(office.longitude) };

                    // Create a button for the office
                    const officeButton = document.createElement("button");
                    officeButton.className = "office-btn";
                    officeButton.textContent = office.id.replace(' Office Postcode', '');
                    officeButton.addEventListener("click", () => focusOnOffice(officeLatLng));
                    officeButtonsContainer.appendChild(officeButton);

                    // Add an office marker
                    new google.maps.Marker({
                        position: officeLatLng,
                        map: googleMap,
                        icon: {
                            url: "http://maps.google.com/mapfiles/kml/pushpin/purple-pushpin.png", // Custom Office Icon
                            scaledSize: new google.maps.Size(30, 30),
                        },
                        title: `${office.id.replace(' Office Postcode', '')}: ${office.nearByEmployees.length} employees`,
                    });

                    let distances = await Promise.all(office.nearByEmployees.map((employee) => {
                        return getShortestDistance(employee.zip_code, office.zip_code);
                    }));
                    distances = distances.filter((d) => d > 0);
                    const maxDistance = Math.max(...distances);

                    if (maxDistance > 0) {
                        // Draw a circle around the office to represent the area (optional)
                        new google.maps.Circle({
                            strokeColor: "#0000FF",
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: "#0000FF",
                            fillOpacity: 0.1,
                            map: googleMap,
                            center: officeLatLng,
                            radius: maxDistance, // miles in meters
                        });
                    }
                } catch (error) {
                    console.error("plotOfficeLocations: Failed to plot office locations:", error);
                }
            }));
        }

        /**
         * Plots employee locations on the map.
         * @param {{ employeeList: Array<Object> }} data - The processed data.
         */
        async function plotEmployeeLocations(employeeList) {
            try {
                employeeList.forEach(employee => {
                    if (employee.nearByOffices && employee.nearByOffices.length > 0) {
                        return;
                    }

                    const employeeLatLng = { lat: parseFloat(employee.latitude), lng: parseFloat(employee.longitude) };
                    const employeeMarker = new google.maps.Marker({
                        position: employeeLatLng,
                        map: googleMap,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 5,
                            fillColor: 'red',
                            fillOpacity: 1,
                            strokeWeight: 1,
                            strokeColor: "white",
                        },
                        title: `Employee ID: ${employee.id}`,
                    });
                });
            } catch (error) {
                console.error("plotEmployeeLocations: Failed to plot employee locations:", error);
            }
        }

        async function isEmployeeOfficeGoodMatch(employee, office) {
            try {
                const origin = employee.zip_code.split(' ').join('').toUpperCase();
                const destination = office.zip_code.split(' ').join('').toUpperCase();
                const data = zipCodeDistanceAndTimeMatrix.find((d) => d.source === origin && d.destination === destination);
                if (!data) {
                    return false;
                }
                const { aerialDistance, drivingDistance, drivingTime, bicycleDistance, bicycleTime } = data;
                const distanceInRange = (radiusMilesThreshold > 0) ? (drivingDistance && drivingDistance < radiusMilesThreshold) : true;
                const timeInRange = (travelTimeThreshold > 0) ? (drivingTime && drivingTime < travelTimeThreshold) : true;
                if (distanceInRange && timeInRange) {
                    return true;
                }
            } catch (error) {
                console.warn("Failed to evaluate isEmployeeOfficeGoodMatch:", error);
            }
            return false;
        }

        /**
         * Focuses the map on a specific office location.
         * @param {{ lat: number, lng: number }} officeLatLng - The office location.
         */
        function focusOnOffice(officeLatLng) {
            googleMap.setCenter(officeLatLng);
            googleMap.setZoom(10); // Adjust zoom level as needed
        }

        // Event Listeners
        document.addEventListener("DOMContentLoaded", showUI);
    </script>
</body>

</html>