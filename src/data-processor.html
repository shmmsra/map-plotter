<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel File Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
        }

        .container {
            width: 80%;
            max-width: 900px;
            background-color: white;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        h1,
        h3 {
            text-align: center;
        }

        .header,
        .footer {
            text-align: center;
            margin-bottom: 20px;
        }

        .tools-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tool-item {
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .tool-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tool-inputs {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tool-actions {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
        }

        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .footer button {
            margin-top: 20px;
        }

        input[type="file"] {
            margin: 10px 0;
        }

        input[type="text"] {
            padding: 8px;
            font-size: 14px;
        }

        input[type="checkbox"] {
            margin-right: 5px;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Excel File Processor</h1>

        <div class="header">
            <h3>Upload Excel File</h3>
            <input type="file" id="fileInput" accept=".xlsx">
            <p id="fileName"></p>
        </div>

        <div class="tools-list" id="toolsList">
            <!-- Tool items will be inserted here -->
        </div>

        <div class="footer">
            <button id="exportJSON" disabled>Export All JSON</button>
            <button id="exportExcel" disabled>Export All Excel</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let excelData = null;
        const outputData = [];

        // Tools/Functions
        const tools = [
            {
                title: "Generate Geocodes",
                id: "generateGeocodes",
                name: "Geocodes",
                parameters: [
                    // { type: "text", label: "Column Name" }
                ],
                execute: async (params) => {
                    // Simulate a delay for async operation
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Mock function to sum a column
                    const column = params[0];
                    let sum = 0;
                    // Assuming excelData contains array of objects where key is the column name
                    excelData.forEach(row => {
                        sum += parseFloat(row[column]) || 0;
                    });
                    return { result: `Sum of column ${column}: ${sum}` };
                }
            },
            {
                title: "Generate Distance and Time Matrix",
                id: "generateDistanceMatrix",
                name: "DistanceTimeMatrix",
                parameters: [
                    { type: "checkbox", label: "Aerial distance", checked: true },
                    { type: "checkbox", label: "Driving distance", checked: false },
                    { type: "checkbox", label: "Bicycle distance", checked: false },
                    { type: "checkbox", label: "Driving Time", checked: false },
                ],
                execute: async (params) => {
                    // Simulate a delay for async operation
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Mock function to count rows
                    const includeEmptyRows = params[0];
                    const ignoreHeaders = params[1];
                    let count = excelData.length;

                    // Reduce count based on conditions
                    if (!includeEmptyRows) {
                        count = excelData.filter(row => Object.values(row).some(val => val !== "")).length;
                    }
                    if (ignoreHeaders) {
                        count--;  // Assuming first row is the header
                    }
                    return { result: `Total Rows (after conditions): ${count}` };
                }
            }
        ];

        // Event handler for file upload
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `File: ${file.name}`;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(firstSheet);
                    alert('File loaded successfully');
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // Load tool items
        const toolsList = document.getElementById('toolsList');
        tools.forEach((tool, index) => {
            const toolDiv = document.createElement('div');
            toolDiv.className = 'tool-item';

            // Tool title
            const toolHeader = document.createElement('div');
            toolHeader.className = 'tool-header';
            toolHeader.textContent = tool.title;
            toolDiv.appendChild(toolHeader);

            // Tool inputs
            const toolInputs = document.createElement('div');
            toolInputs.className = 'tool-inputs';
            tool.parameters.forEach(param => {
                const label = document.createElement('label');
                const input = document.createElement('input');
                input.type = param.type;
                input.placeholder = param.label;

                if (param.type === 'checkbox') {
                    const checkboxWrapper = document.createElement('div');
                    checkboxWrapper.className = 'checkbox-group';
                    input.checked = param.checked;
                    label.textContent = param.label;
                    checkboxWrapper.appendChild(input);
                    checkboxWrapper.appendChild(label);
                    toolInputs.appendChild(checkboxWrapper);
                } else {
                    toolInputs.appendChild(input);
                }
            });

            const toolActions = document.createElement('div');
            toolActions.className = 'tool-actions';
            const executeBtn = document.createElement('button');
            executeBtn.textContent = 'Execute';
            const exportJSONBtn = document.createElement('button');
            exportJSONBtn.textContent = 'Export JSON';
            exportJSONBtn.disabled = true;
            const exportExcelBtn = document.createElement('button');
            exportExcelBtn.textContent = 'Export Excel';
            exportExcelBtn.disabled = true;

            const spinner = document.createElement('div');
            spinner.className = 'spinner';

            // Event handler for async execute function
            executeBtn.addEventListener('click', async () => {
                const inputs = Array.from(toolInputs.querySelectorAll('input')).map(input => input.type === 'checkbox' ? input.checked : input.value);

                // Disable execute button and show spinner
                executeBtn.disabled = true;
                spinner.style.display = 'inline-block';

                try {
                    const result = await tool.execute(inputs);
                    outputData.push(result);
                    alert(result.result);
                } catch (error) {
                    alert('An error occurred during execution');
                } finally {
                    // Hide spinner and enable execute button
                    spinner.style.display = 'none';
                    executeBtn.disabled = false;
                    exportJSONBtn.disabled = false;
                    exportExcelBtn.disabled = false;
                    document.getElementById('exportJSON').disabled = false;
                    document.getElementById('exportExcel').disabled = false;
                }
            });

            toolActions.appendChild(spinner);
            toolActions.appendChild(executeBtn);
            toolActions.appendChild(exportJSONBtn);
            toolActions.appendChild(exportExcelBtn);

            toolDiv.appendChild(toolInputs);
            toolDiv.appendChild(toolActions);
            toolsList.appendChild(toolDiv);

            exportJSONBtn.addEventListener('click', () => {
                const json = JSON.stringify(outputData[index], null, 2);
                downloadFile(json, `function_${index}_output.json`, 'application/json');
            });

            exportExcelBtn.addEventListener('click', () => {
                const ws = XLSX.utils.json_to_sheet([outputData[index]]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, `function_${index}_output.xlsx`);
            });
        });

        // Export all JSON
        document.getElementById('exportJSON').addEventListener('click', () => {
            const json = JSON.stringify(outputData, null, 2);
            downloadFile(json, 'all_functions_output.json', 'application/json');
        });

        // Export all Excel
        document.getElementById('exportExcel').addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(outputData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, 'all_functions_output.xlsx');
        });

        // Helper function to download file
        function downloadFile(data, filename, type) {
            const file = new Blob([data], { type });
            const a = document.createElement('a');
            const url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
    </script>
</body>

</html>